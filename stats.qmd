---
title: "Summary statistics"
execute:
  echo: false
---


```{python}
import pandas as pd
from datetime import datetime, timedelta
import matplotlib.pyplot as plt

CSV_PATH = "data/output.csv"
df = pd.read_csv(CSV_PATH)
df['timestamp'] = pd.to_datetime(df['timestamp'])
now = datetime.now()

# Stats: observations per hour (last day)
last_day_df = df[df['timestamp'] > now - timedelta(days=7)]

# --- Aggregate counts per species ---
result = (
    last_day_df
    .groupby("species")
    .size()
    .reset_index(name="count")
    .sort_values("count", ascending=False)
    .reset_index(drop=True) 
)

if len(result) >0:

# ---- HEATMAP (last 7 days × 24 hours) ----

    DAYS = 7
    cutoff = now - timedelta(days=DAYS)

    # create empty heatmap: DAYS rows × 24 columns
    heatmap = [[0 for _ in range(24)] for _ in range(DAYS)]

    for _, row in df.iterrows():
        ts = row["timestamp"]
        if ts > cutoff:
            age = (now - ts).days
            if age < DAYS:
                # "days - age - 1" reproduces your original mapping
                heatmap[DAYS - age - 1][ts.hour] += 1

    # Convert to DataFrame for convenient plotting
    import numpy as np
    heatmap_arr = np.array(heatmap)

    plt.figure(figsize=(12, 4))
    plt.imshow(heatmap_arr, aspect="auto", cmap="viridis")
    plt.colorbar(label="Observations")

    plt.xlabel("Hour of Day")
    plt.ylabel("Days Ago")
    plt.title("Heatmap of Observations (Last 7 Days)")

    plt.xticks(range(24))
    plt.yticks(range(DAYS), range(DAYS - 1, -1, -1))

    plt.show()

    stats = last_day_df.groupby(last_day_df['timestamp'].dt.hour).size()

    stats.plot(kind='bar', legend=False)
    plt.xlabel("Hour of Day")
    plt.ylabel("Observations")
    plt.title("Observations per Hour (Last 7 days)")
    plt.show()

    for i in range(10):
        bird = result["species"].iloc[i]
        filtered = last_day_df[last_day_df["species"] == bird]
        filtered_stats = filtered.groupby(filtered['timestamp'].dt.hour).size()
        filtered_stats = (
        filtered_stats
        .reindex(range(24), fill_value=0))
        #filtered_stats = filtered_stats/filtered_stats.max()
        filtered_stats.plot(kind="line", label = bird)    
    plt.xlabel("Hour of Day")
    plt.ylabel("Observations")
    plt.title("Observations per Hour (Last 7 days)")
    plt.legend()
    plt.show()
else:
    print("No observations in the last week")

```
